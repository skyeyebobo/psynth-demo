<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dr. Horch Demo</title>
<style>
    body {
        font-family: Arial, sans-serif;
        background-color: #f7f3eb;
        color: #333;
        text-align: center;
        padding: 30px;
    }
    h1 {
        color: #2f3b2f;
    }
    #sessionBox {
        width: 80%;
        max-width: 600px;
        margin: 0 auto;
        background-color: #ffffff;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0px 4px 10px rgba(0,0,0,0.1);
    }
    textarea {
        width: 100%;
        height: 100px;
        padding: 10px;
        font-size: 14px;
        margin-bottom: 10px;
    }
    button {
        padding: 10px 20px;
        font-size: 16px;
        background-color: #2f3b2f;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
    }
    #output {
        margin-top: 20px;
        font-style: italic;
        min-height: 50px;
    }
    #status {
        margin-top: 15px;
        font-size: 14px;
        color: #2f3b2f;
        font-weight: bold;
    }
</style>
</head>
<body>

<h1>Dr. Horch Demo</h1>
<div id="sessionBox">
    <textarea id="inputText" placeholder="Type or dictate your thoughts here..."></textarea><br>
    <button onclick="processInput()">Process</button>
    <button onclick="startVoiceInput()">üéôÔ∏è Speak</button>
    <div id="output"></div>
    <div id="status"></div>
</div>

<script>
let recognition;
let speechQueue = [];
let isSpeaking = false;
let lastReflection = "";
let selectedVoice = null;

// Voice input (mic)
function startVoiceInput() {
    if (!('webkitSpeechRecognition' in window)) {
        alert("Speech recognition not supported on this browser.");
        return;
    }
    recognition = new webkitSpeechRecognition();
    recognition.lang = "en-US";
    recognition.interimResults = false;
    recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        document.getElementById("inputText").value = transcript;
    };
    recognition.start();
}

// Fake reflection (demo logic)
function generateReflection(input) {
    return `I hear you saying: "${input}". Let us stay with that feeling for a moment...`;
}

// Process input
function processInput() {
    const inputElem = document.getElementById("inputText");
    const input = inputElem.value.trim();
    if (!input) return;

    const reflection = generateReflection(input);

    // Only speak if it‚Äôs new
    if (reflection !== lastReflection) {
        document.getElementById("output").innerText = reflection;
        queueSpeech(reflection);
        lastReflection = reflection;
    }

    // Clear input
    inputElem.value = "";
}

// Queue system
function queueSpeech(text) {
    speechQueue.push(text);
    if (!isSpeaking) {
        playNextInQueue();
    }
}

function playNextInQueue() {
    if (speechQueue.length === 0) {
        isSpeaking = false;
        return;
    }
    const text = speechQueue.shift();
    speakText(text, playNextInQueue);
}

// Speech synthesis
function speakText(text, callback) {
    if (speechSynthesis.speaking || speechSynthesis.pending) {
        speechSynthesis.cancel();
    }

    const utterance = new SpeechSynthesisUtterance(text);

    // Find voice if not set
    if (!selectedVoice) {
        const voices = speechSynthesis.getVoices();
        // Try to find a German male voice
        selectedVoice = voices.find(v => v.lang.includes("de") && v.name.toLowerCase().includes("male"))
                       || voices.find(v => v.lang.includes("de"))
                       || voices.find(v => v.lang.includes("en") && v.name.toLowerCase().includes("male"))
                       || voices[0]; // fallback
    }
    utterance.voice = selectedVoice;

    // Voice style
    utterance.pitch = 0.8;   // deeper
    utterance.rate = 0.85;   // slower
    utterance.volume = 1.0;

    isSpeaking = true;
    document.getElementById("status").innerText = "üü¢ Dr. Horch is speaking...";

    utterance.onend = () => {
        isSpeaking = false;
        document.getElementById("status").innerText = "";
        callback();
    };

    utterance.onerror = (e) => {
        console.error("Speech synthesis error:", e);
        isSpeaking = false;
        document.getElementById("status").innerText = "";
        callback();
    };

    speechSynthesis.speak(utterance);
}

// Ensure voices are loaded
speechSynthesis.onvoiceschanged = () => {
    if (!selectedVoice) {
        selectedVoice = speechSynthesis.getVoices().find(v => v.lang.includes("de")) || null;
    }
};
</script>

</body>
</html>
